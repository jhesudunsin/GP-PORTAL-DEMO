<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digital Tools Portal - GP Practice</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .auth-card {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .auth-card h1 {
            color: #1e3c72;
            margin-bottom: 10px;
            font-size: 2em;
        }

        .auth-card p {
            color: #6c757d;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
        }

        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            width: 100%;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            margin-bottom: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .hidden {
            display: none;
        }

        /* Main App Styles (same as before) */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 20px 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 1.8em;
            margin-bottom: 5px;
        }

        .header .practice-name {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .user-info {
            text-align: right;
        }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            margin-top: 5px;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
        }

        .nav-tab {
            padding: 15px 25px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: #6c757d;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .nav-tab.active {
            color: #1e3c72;
            border-bottom-color: #1e3c72;
            background: white;
        }

        .nav-tab:hover:not(.active) {
            background: #e9ecef;
            color: #495057;
        }

        .content {
            padding: 30px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            text-align: center;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            border-color: #667eea;
        }

        .card-number {
            font-size: 2.5em;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .card-label {
            color: #6c757d;
            font-weight: 600;
        }

        .compliant { color: #28a745; }
        .non-compliant { color: #dc3545; }
        .pending { color: #ffc107; }
        .total { color: #667eea; }

        .quick-actions {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .tools-table {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            margin-bottom: 30px;
        }

        .tools-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .tools-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            font-size: 12px;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        .tools-table td {
            padding: 15px;
            border-bottom: 1px solid #e9ecef;
        }

        .tools-table tr:hover {
            background: #f8f9fa;
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-compliant {
            background: #d4edda;
            color: #155724;
        }

        .status-action-required {
            background: #f8d7da;
            color: #721c24;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .form-container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            margin-bottom: 20px;
        }

        .form-buttons {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        .notification {
            background: #d1ecf1;
            color: #0c5460;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #bee5eb;
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
            color: white;
        }

        select, textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .help-text {
            font-size: 12px;
            color: #6c757d;
            margin-top: 5px;
            font-style: italic;
        }

        @media (max-width: 768px) {
            .dashboard-cards {
                grid-template-columns: 1fr;
            }
            
            .quick-actions {
                flex-direction: column;
            }
            
            .nav-tabs {
                flex-wrap: wrap;
            }
            
            .form-buttons {
                flex-direction: column;
            }

            .content {
                padding: 15px;
            }

            .header {
                flex-direction: column;
                text-align: center;
            }

            .user-info {
                text-align: center;
                margin-top: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- Authentication Screen -->
    <div id="authScreen" class="auth-container">
        <div class="auth-card">
            <h1>🏥 GP Digital Tools Portal</h1>
            <p>NHS Derby and Derbyshire ICB</p>
            
            <div id="errorMessage" class="error-message hidden"></div>
            <div id="successMessage" class="success-message hidden"></div>
            
            <!-- Login Form -->
            <div id="loginForm">
                <form onsubmit="loginUser(event)">
                    <div class="form-group">
                        <label>Email Address:</label>
                        <input type="email" id="loginEmail" required placeholder="your.practice@nhs.uk">
                    </div>
                    
                    <div class="form-group">
                        <label>Password:</label>
                        <input type="password" id="loginPassword" required placeholder="Enter your password">
                    </div>
                    
                    <button type="submit" class="btn btn-primary" id="loginBtn">
                        Sign In
                    </button>
                </form>
                
                <p style="margin-top: 20px; color: #6c757d; font-size: 14px;">
                    First time? <a href="#" onclick="showRegisterForm()" style="color: #667eea;">Create account</a>
                </p>
                
                <p style="margin-top: 10px;">
                    <a href="#" onclick="showForgotPassword()" style="color: #667eea; font-size: 14px;">Forgot password?</a>
                </p>
            </div>
            
            <!-- Registration Form -->
            <div id="registerForm" class="hidden">
                <form onsubmit="registerUser(event)">
                    <div class="form-group">
                        <label>Practice Name:</label>
                        <input type="text" id="registerPracticeName" required placeholder="e.g. Mickleover Medical Centre">
                    </div>
                    
                    <div class="form-group">
                        <label>PCN:</label>
                        <select id="registerPCN" required>
                            <option value="">Select your PCN...</option>
                            <option value="Derby City">Derby City PCN</option>
                            <option value="South Derbyshire">South Derbyshire PCN</option>
                            <option value="Amber Valley">Amber Valley PCN</option>
                            <option value="Erewash">Erewash PCN</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Email Address:</label>
                        <input type="email" id="registerEmail" required placeholder="practice.manager@nhs.uk">
                    </div>
                    
                    <div class="form-group">
                        <label>Password:</label>
                        <input type="password" id="registerPassword" required placeholder="Create a secure password">
                    </div>
                    
                    <button type="submit" class="btn btn-primary" id="registerBtn">
                        Create Account
                    </button>
                </form>
                
                <p style="margin-top: 20px; color: #6c757d; font-size: 14px;">
                    Already have an account? <a href="#" onclick="showLoginForm()" style="color: #667eea;">Sign in</a>
                </p>
            </div>
            
            <!-- Forgot Password Form -->
            <div id="forgotPasswordForm" class="hidden">
                <form onsubmit="resetPassword(event)">
                    <p style="margin-bottom: 20px; color: #6c757d; font-size: 14px;">
                        Enter your email address and we'll send you a password reset link.
                    </p>
                    
                    <div class="form-group">
                        <label>Email Address:</label>
                        <input type="email" id="resetEmail" required placeholder="your.practice@nhs.uk">
                    </div>
                    
                    <button type="submit" class="btn btn-primary" id="resetBtn">
                        Send Reset Link
                    </button>
                </form>
                
                <p style="margin-top: 20px; color: #6c757d; font-size: 14px;">
                    <a href="#" onclick="showLoginForm()" style="color: #667eea;">Back to login</a>
                </p>
            </div>
        </div>
    </div>

    <!-- Main Application (hidden initially) -->
    <div id="mainApp" class="hidden">
        <div class="container">
            <div class="header">
                <div>
                    <h1>🏥 Digital Tools Portal</h1>
                    <div class="practice-name" id="practiceNameHeader">Loading...</div>
                </div>
                <div class="user-info">
                    <div id="userEmail">Loading...</div>
                    <button class="logout-btn" onclick="logoutUser()">Sign Out</button>
                </div>
            </div>

            <div class="nav-tabs">
                <button class="nav-tab active" onclick="showTab('dashboard')">📊 Dashboard</button>
                <button class="nav-tab" onclick="showTab('tools')">🔧 Our Tools</button>
                <button class="nav-tab" onclick="showTab('assessment')">📋 Monthly Check</button>
                <button class="nav-tab" onclick="showTab('reports')">📊 Reports</button>
            </div>

            <div class="content">
                <!-- Dashboard Tab -->
                <div id="dashboard" class="tab-content active">
                    <div class="dashboard-cards">
                        <div class="card">
                            <div class="card-number total" id="totalTools">0</div>
                            <div class="card-label">Tools Registered</div>
                        </div>
                        <div class="card">
                            <div class="card-number compliant" id="compliantTools">0</div>
                            <div class="card-label">Compliant</div>
                        </div>
                        <div class="card">
                            <div class="card-number non-compliant" id="actionRequired">0</div>
                            <div class="card-label">Action Required</div>
                        </div>
                        <div class="card">
                            <div class="card-number pending" id="pendingReview">0</div>
                            <div class="card-label">Pending Review</div>
                        </div>
                    </div>

                    <div class="quick-actions">
                        <button class="btn btn-primary" onclick="showAddTool()">+ Add New Tool</button>
                        <button class="btn btn-warning" onclick="showTab('assessment')">Complete Monthly Check</button>
                        <button class="btn btn-success" onclick="refreshData()">🔄 Refresh Data</button>
                    </div>

                    <div class="notification">
                        <strong>📅 Reminder:</strong> Your monthly digital tools assessment is due by June 30th, 2025.
                    </div>

                    <div class="tools-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>Tool Name</th>
                                    <th>Type</th>
                                    <th>Status</th>
                                    <th>Last Updated</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="toolsTableBody">
                                <tr>
                                    <td colspan="5" style="text-align: center; padding: 40px; color: #6c757d;">
                                        Loading your tools...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Tools Tab -->
                <div id="tools" class="tab-content">
                    <div class="quick-actions">
                        <button class="btn btn-primary" onclick="showAddTool()">+ Add New Tool</button>
                        <button class="btn btn-success" onclick="refreshData()">🔄 Refresh Data</button>
                    </div>

                    <div class="form-container" id="addToolForm" style="display: none;">
                        <h3>Add New Digital Tool</h3>
                        <form id="newToolForm" onsubmit="submitNewTool(event)">
                            <div class="form-group">
                                <label>What tool are you using? <span style="color: red;">*</span></label>
                                <input type="text" id="toolName" placeholder="e.g. Dragon Medical One, AccuRx, Teams" required>
                                <div class="help-text">Enter the exact name of the software or system</div>
                            </div>

                            <div class="form-group">
                                <label>What type of tool is this? <span style="color: red;">*</span></label>
                                <select id="toolType" required>
                                    <option value="">Select tool type...</option>
                                    <option value="AI Voice Technology">AI Voice/Speech Recognition</option>
                                    <option value="Online Consultation">Online Consultation (e.g. AccuRx)</option>
                                    <option value="Video Consultation">Video Consultation</option>
                                    <option value="Clinical Decision Support">Clinical Decision Support</option>
                                    <option value="Administrative Tool">Administrative Tool</option>
                                    <option value="Other">Other (please specify below)</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label>Who supplies this tool?</label>
                                <input type="text" id="toolVendor" placeholder="e.g. Nuance, AccuRx Ltd, Microsoft">
                                <div class="help-text">Company or vendor name</div>
                            </div>

                            <div class="form-group">
                                <label>Has this tool been approved for NHS use?</label>
                                <select id="nhsApproved">
                                    <option value="">Select...</option>
                                    <option value="Yes">Yes</option>
                                    <option value="No">No</option>
                                    <option value="Don't Know">Don't Know</option>
                                </select>
                                <div class="help-text">This means it meets MHRA and NHS Digital requirements</div>
                            </div>

                            <div class="form-group">
                                <label>Have you completed a Data Protection Impact Assessment (DPIA)?</label>
                                <select id="dpiaStatus">
                                    <option value="">Select...</option>
                                    <option value="Yes - Completed">Yes - Completed</option>
                                    <option value="No - Not Done">No - Not Done</option>
                                    <option value="Don't Know">Don't Know</option>
                                    <option value="What's a DPIA?">What's a DPIA?</option>
                                </select>
                                <div class="help-text">This checks if patient data is handled safely</div>
                            </div>

                            <div class="form-group">
                                <label>Has a clinical safety assessment been done?</label>
                                <select id="clinicalSafety">
                                    <option value="">Select...</option>
                                    <option value="Yes - Complete">Yes - Complete</option>
                                    <option value="No - Not Done">No - Not Done</option>
                                    <option value="Don't Know">Don't Know</option>
                                    <option value="Need Help">Need Help</option>
                                </select>
                                <div class="help-text">This ensures the tool is safe for patient care</div>
                            </div>

                            <div class="form-group">
                                <label>Additional Notes</label>
                                <textarea id="toolNotes" rows="3" placeholder="Any other information about this tool..."></textarea>
                            </div>

                            <div class="form-buttons">
                                <button type="submit" class="btn btn-primary">Save Tool</button>
                                <button type="button" class="btn btn-secondary" onclick="hideAddTool()">Cancel</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Assessment Tab -->
                <div id="assessment" class="tab-content">
                    <div class="form-container">
                        <h3>Monthly Digital Tools Assessment</h3>
                        <p style="margin-bottom: 20px; color: #6c757d;">This quick check helps us ensure all your digital tools remain safe and compliant. Takes about 5 minutes.</p>

                        <form id="monthlyAssessmentForm" onsubmit="submitAssessment(event)">
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                                <h4 style="margin-bottom: 15px; color: #1e3c72;">1. New Tools Check</h4>
                                <div class="form-group">
                                    <label>Are you using any NEW digital tools since last month?</label>
                                    <select id="newToolsCheck">
                                        <option value="">Select...</option>
                                        <option value="yes">Yes</option>
                                        <option value="no">No</option>
                                    </select>
                                </div>
                            </div>

                            <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                                <h4 style="margin-bottom: 15px; color: #1e3c72;">2. Safety & Compliance Check</h4>
                                <div class="form-group">
                                    <label>Are any tools causing patient safety concerns?</label>
                                    <select id="safetyCheck">
                                        <option value="">Select...</option>
                                        <option value="yes">Yes - Urgent</option>
                                        <option value="no">No</option>
                                    </select>
                                    <div class="help-text">If Yes, this will send an immediate alert to the ICB team</div>
                                </div>

                                <div class="form-group">
                                    <label>Do you need help with compliance for any tools?</label>
                                    <select id="needHelp">
                                        <option value="">Select...</option>
                                        <option value="yes">Yes - Please Contact Me</option>
                                        <option value="no">No</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label>Additional Comments</label>
                                    <textarea id="assessmentNotes" rows="3" placeholder="Any other concerns or updates..."></textarea>
                                </div>
                            </div>

                            <div class="form-buttons">
                                <button type="submit" class="btn btn-success">Complete Monthly Check</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Reports Tab -->
                <div id="reports" class="tab-content">
                    <div class="form-container">
                        <h3>Our Compliance Reports</h3>
                        
                        <div class="quick-actions">
                            <button class="btn btn-primary" onclick="generateCurrentReport()">Current Status Report</button>
                        </div>

                        <div class="tools-table">
                            <h4 style="margin-bottom: 15px;">Recent Activity</h4>
                            <table>
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Activity</th>
                                        <th>Tool</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td colspan="4" style="text-align: center; padding: 40px; color: #6c757d;">
                                            Activity log will appear here
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase Scripts -->
    <script type="module">
        // Import Firebase functions
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail, updateProfile } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, getDocs, doc, updateDoc, serverTimestamp, orderBy } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAH_u0NOKNn1EzyI_tmbW9b6DkT3_VoLEg",
            authDomain: "gp-digital-tools-compliance.firebaseapp.com",
            projectId: "gp-digital-tools-compliance",
            storageBucket: "gp-digital-tools-compliance.firebasestorage.app",
            messagingSenderId: "996931877791",
            appId: "1:996931877791:web:b9b03b675b034d88f95baa",
            measurementId: "G-0PG1H53R8L"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Global variables
        let currentUser = null;
        let practiceTools = [];

        // Make functions global so HTML can access them
        window.loginUser = loginUser;
        window.registerUser = registerUser;
        window.resetPassword = resetPassword;
        window.logoutUser = logoutUser;
        window.showLoginForm = showLoginForm;
        window.showRegisterForm = showRegisterForm;
        window.showForgotPassword = showForgotPassword;
        window.showTab = showTab;
        window.showAddTool = showAddTool;
        window.hideAddTool = hideAddTool;
        window.submitNewTool = submitNewTool;
        window.submitAssessment = submitAssessment;
        window.refreshData = refreshData;
        window.generateCurrentReport = generateCurrentReport;

        // Authentication state listener
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                showMainApp();
                loadUserData();
            } else {
                currentUser = null;
                showAuthScreen();
            }
        });

        // Authentication functions
        async function loginUser(event) {
            event.preventDefault();
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const loginBtn = document.getElementById('loginBtn');
            
            try {
                loginBtn.textContent = 'Signing in...';
                loginBtn.disabled = true;
                hideMessages();
                
                await signInWithEmailAndPassword(auth, email, password);
                // Success handled by onAuthStateChanged
                
            } catch (error) {
                console.error('Login error:', error);
                showError(getErrorMessage(error.code));
                
                loginBtn.textContent = 'Sign In';
                loginBtn.disabled = false;
            }
        }

        async function registerUser(event) {
            event.preventDefault();
            
            const practiceName = document.getElementById('registerPracticeName').value;
            const pcn = document.getElementById('registerPCN').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const registerBtn = document.getElementById('registerBtn');
            
            try {
                registerBtn.textContent = 'Creating account...';
                registerBtn.disabled = true;
                hideMessages();
                
                // Create user account
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                
                // Update user profile with practice info
                await updateProfile(userCredential.user, {
                    displayName: `${practiceName}|${pcn}` // Store both practice name and PCN
                });
                
                showSuccess('Account created successfully! You can now access your portal.');
                
                // Auto-switch to login form after short delay
                setTimeout(() => {
                    showLoginForm();
                }, 2000);
                
            } catch (error) {
                console.error('Registration error:', error);
                showError(getErrorMessage(error.code));
                
                registerBtn.textContent = 'Create Account';
                registerBtn.disabled = false;
            }
        }

        async function resetPassword(event) {
            event.preventDefault();
            
            const email = document.getElementById('resetEmail').value;
            const resetBtn = document.getElementById('resetBtn');
            
            try {
                resetBtn.textContent = 'Sending...';
                resetBtn.disabled = true;
                hideMessages();
                
                await sendPasswordResetEmail(auth, email);
                showSuccess('Password reset email sent! Check your inbox.');
                
                setTimeout(() => {
                    showLoginForm();
                }, 3000);
                
            } catch (error) {
                console.error('Reset password error:', error);
                showError(getErrorMessage(error.code));
                
                resetBtn.textContent = 'Send Reset Link';
                resetBtn.disabled = false;
            }
        }

        async function logoutUser() {
            try {
                await signOut(auth);
                // Success handled by onAuthStateChanged
            } catch (error) {
                console.error('Logout error:', error);
            }
        }

        // UI Display functions
        function showMainApp() {
            document.getElementById('authScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            
            // Update header with user info
            if (currentUser) {
                document.getElementById('userEmail').textContent = currentUser.email;
                
                if (currentUser.displayName) {
                    const [practiceName, pcn] = currentUser.displayName.split('|');
                    document.getElementById('practiceNameHeader').textContent = `${practiceName} - ${pcn || 'PCN'}`;
                } else {
                    document.getElementById('practiceNameHeader').textContent = 'Practice Portal';
                }
            }
        }

        function showAuthScreen() {
            document.getElementById('authScreen').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
        }

        function showLoginForm() {
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('registerForm').classList.add('hidden');
            document.getElementById('forgotPasswordForm').classList.add('hidden');
            hideMessages();
        }

        function showRegisterForm() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.remove('hidden');
            document.getElementById('forgotPasswordForm').classList.add('hidden');
            hideMessages();
        }

        function showForgotPassword() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.add('hidden');
            document.getElementById('forgotPasswordForm').classList.remove('hidden');
            hideMessages();
        }

        // Message display functions
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
            
            setTimeout(() => {
                errorDiv.classList.add('hidden');
            }, 5000);
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('successMessage');
            successDiv.textContent = message;
            successDiv.classList.remove('hidden');
            
            setTimeout(() => {
                successDiv.classList.add('hidden');
            }, 5000);
        }

        function hideMessages() {
            document.getElementById('errorMessage').classList.add('hidden');
            document.getElementById('successMessage').classList.add('hidden');
        }

        function getErrorMessage(errorCode) {
            switch (errorCode) {
                case 'auth/user-not-found':
                    return 'No account found with this email address.';
                case 'auth/wrong-password':
                    return 'Incorrect password. Please try again.';
                case 'auth/email-already-in-use':
                    return 'An account already exists with this email address.';
                case 'auth/weak-password':
                    return 'Password should be at least 6 characters long.';
                case 'auth/invalid-email':
                    return 'Please enter a valid email address.';
                case 'auth/too-many-requests':
                    return 'Too many failed attempts. Please try again later.';
                default:
                    return 'An error occurred. Please try again.';
            }
        }

        // Data loading and management
        async function loadUserData() {
            if (!currentUser) return;
            
            try {
                // Query tools for current user's practice
                const toolsQuery = query(
                    collection(db, 'digitalTools'),
                    where('userEmail', '==', currentUser.email),
                    orderBy('timestamp', 'desc')
                );
                
                const querySnapshot = await getDocs(toolsQuery);
                practiceTools = [];
                
                querySnapshot.forEach((doc) => {
                    practiceTools.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                updateDashboard();
                populateToolsTable();
                
            } catch (error) {
                console.error('Error loading data:', error);
                showError('Error loading your data. Please refresh the page.');
            }
        }

        function updateDashboard() {
            const total = practiceTools.length;
            const compliant = practiceTools.filter(tool => getComplianceStatus(tool) === 'Compliant').length;
            const actionRequired = practiceTools.filter(tool => getComplianceStatus(tool) === 'Action Required').length;
            const pending = practiceTools.filter(tool => getComplianceStatus(tool) === 'Pending').length;

            document.getElementById('totalTools').textContent = total;
            document.getElementById('compliantTools').textContent = compliant;
            document.getElementById('actionRequired').textContent = actionRequired;
            document.getElementById('pendingReview').textContent = pending;
        }

        function getComplianceStatus(tool) {
            if (tool.nhsApproved === 'Yes' && 
                tool.dpiaStatus === 'Yes - Completed' && 
                tool.clinicalSafety === 'Yes - Complete') {
                return 'Compliant';
            } else if (tool.nhsApproved === 'No' || 
                       tool.dpiaStatus === 'No - Not Done' || 
                       tool.clinicalSafety === 'No - Not Done') {
                return 'Action Required';
            } else {
                return 'Pending';
            }
        }

        function populateToolsTable() {
            const tbody = document.getElementById('toolsTableBody');
            
            if (practiceTools.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 40px; color: #6c757d;">
                            No tools registered yet. Click "Add New Tool" to get started.
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = practiceTools.map(tool => {
                const status = getComplianceStatus(tool);
                const statusClass = status === 'Compliant' ? 'status-compliant' : 
                                   status === 'Action Required' ? 'status-action-required' : 'status-pending';
                const statusIcon = status === 'Compliant' ? '✅' : 
                                  status === 'Action Required' ? '❌' : '⏳';
                
                const lastUpdated = tool.timestamp ? 
                    new Date(tool.timestamp.seconds * 1000).toLocaleDateString('en-GB') : 
                    'Just now';

                return `
                    <tr>
                        <td><strong>${tool.toolName}</strong></td>
                        <td>${tool.toolType}</td>
                        <td><span class="status-badge ${statusClass}">${statusIcon} ${status}</span></td>
                        <td>${lastUpdated}</td>
                        <td>
                            <button class="btn btn-primary" style="padding: 5px 10px; font-size: 12px;" onclick="viewTool('${tool.id}')">View</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Tool management functions
        async function submitNewTool(event) {
            event.preventDefault();
            
            if (!currentUser) {
                showError('You must be logged in to add tools.');
                return;
            }

            const submitBtn = document.querySelector('#newToolForm button[type="submit"]');
            
            try {
                submitBtn.textContent = 'Saving...';
                submitBtn.disabled = true;

                const [practiceName, pcn] = currentUser.displayName ? 
                    currentUser.displayName.split('|') : ['Unknown Practice', 'Unknown PCN'];

                const toolData = {
                    userEmail: currentUser.email,
                    practiceName: practiceName,
                    pcn: pcn || 'Unknown PCN',
                    toolName: document.getElementById('toolName').value,
                    toolType: document.getElementById('toolType').value,
                    toolVendor: document.getElementById('toolVendor').value || 'Not specified',
                    nhsApproved: document.getElementById('nhsApproved').value || 'Unknown',
                    dpiaStatus: document.getElementById('dpiaStatus').value || 'Unknown',
                    clinicalSafety: document.getElementById('clinicalSafety').value || 'Unknown',
                    notes: document.getElementById('toolNotes').value || '',
                    timestamp: serverTimestamp(),
                    lastUpdated: serverTimestamp()
                };

                // Add to Firestore
                await addDoc(collection(db, 'digitalTools'), toolData);
                
                // Reset form and hide
                document.getElementById('newToolForm').reset();
                hideAddTool();
                
                // Reload data
                await loadUserData();
                
                showSuccess(`Tool "${toolData.toolName}" has been successfully registered!`);
                
            } catch (error) {
                console.error('Error adding tool:', error);
                showError('Error saving tool. Please try again.');
                
                submitBtn.textContent = 'Save Tool';
                submitBtn.disabled = false;
            }
        }

        async function submitAssessment(event) {
            event.preventDefault();
            
            if (!currentUser) {
                showError('You must be logged in to submit assessment.');
                return;
            }

            const submitBtn = document.querySelector('#monthlyAssessmentForm button[type="submit"]');
            
            try {
                submitBtn.textContent = 'Submitting...';
                submitBtn.disabled = true;

                const [practiceName, pcn] = currentUser.displayName ? 
                    currentUser.displayName.split('|') : ['Unknown Practice', 'Unknown PCN'];

                const assessmentData = {
                    userEmail: currentUser.email,
                    practiceName: practiceName,
                    pcn: pcn || 'Unknown PCN',
                    type: 'monthly_assessment',
                    newToolsCheck: document.getElementById('newToolsCheck').value,
                    safetyCheck: document.getElementById('safetyCheck').value,
                    needHelp: document.getElementById('needHelp').value,
                    assessmentNotes: document.getElementById('assessmentNotes').value || '',
                    timestamp: serverTimestamp()
                };

                // Add to Firestore
                await addDoc(collection(db, 'assessments'), assessmentData);
                
                // Reset form
                document.getElementById('monthlyAssessmentForm').reset();
                
                showSuccess('Monthly assessment completed successfully! The ICB team has been notified.');
                
                // If safety concerns, show additional message
                if (assessmentData.safetyCheck === 'yes') {
                    setTimeout(() => {
                        showError('Safety concerns reported. The ICB team has been immediately notified and will contact you within 1 hour.');
                    }, 2000);
                }
                
            } catch (error) {
                console.error('Error submitting assessment:', error);
                showError('Error submitting assessment. Please try again.');
            } finally {
                submitBtn.textContent = 'Complete Monthly Check';
                submitBtn.disabled = false;
            }
        }

        // Utility functions
        function showTab(tabName) {
            // Hide all tab contents
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(tab => tab.classList.remove('active'));
            
            // Remove active class from all tabs
            const tabs = document.querySelectorAll('.nav-tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            // Show selected tab content
            document.getElementById(tabName).classList.add('active');
            
            // Add active class to clicked tab
            event.target.classList.add('active');
            
            // Hide add tool form when switching tabs
            hideAddTool();
        }

        function showAddTool() {
            document.getElementById('addToolForm').style.display = 'block';
            document.getElementById('addToolForm').scrollIntoView({ behavior: 'smooth' });
        }

        function hideAddTool() {
            document.getElementById('addToolForm').style.display = 'none';
            document.getElementById('newToolForm').reset();
        }

        function viewTool(toolId) {
            const tool = practiceTools.find(t => t.id === toolId);
            if (tool) {
                alert(`Tool Details:\n\nName: ${tool.toolName}\nType: ${tool.toolType}\nVendor: ${tool.toolVendor}\nNHS Approved: ${tool.nhsApproved}\nDPIA: ${tool.dpiaStatus}\nClinical Safety: ${tool.clinicalSafety}\nNotes: ${tool.notes}`);
            }
        }

        async function refreshData() {
            const refreshBtn = event.target;
            const originalText = refreshBtn.textContent;
            
            refreshBtn.textContent = '🔄 Refreshing...';
            refreshBtn.disabled = true;
            
            try {
                await loadUserData();
                showSuccess('Data refreshed successfully!');
            } catch (error) {
                showError('Error refreshing data.');
            } finally {
                refreshBtn.textContent = originalText;
                refreshBtn.disabled = false;
            }
        }

        function generateCurrentReport() {
            const total = practiceTools.length;
            const compliant = practiceTools.filter(tool => getComplianceStatus(tool) === 'Compliant').length;
            const actionRequired = practiceTools.filter(tool => getComplianceStatus(tool) === 'Action Required').length;
            const pending = practiceTools.filter(tool => getComplianceStatus(tool) === 'Pending').length;
            
            const [practiceName] = currentUser.displayName ? 
                currentUser.displayName.split('|') : ['Your Practice'];
            
            let report = `Digital Tools Compliance Report\n`;
            report += `Practice: ${practiceName}\n`;
            report += `Generated: ${new Date().toLocaleDateString('en-GB')}\n\n`;
            report += `Summary:\n`;
            report += `- Total Tools: ${total}\n`;
            report += `- Compliant: ${compliant}\n`;
            report += `- Action Required: ${actionRequired}\n`;
            report += `- Pending Review: ${pending}\n\n`;
            
            if (actionRequired > 0) {
                report += `Tools Requiring Action:\n`;
                practiceTools.filter(tool => getComplianceStatus(tool) === 'Action Required').forEach(tool => {
                    report += `- ${tool.toolName} (${tool.toolType})\n`;
                });
            }
            
            // Create downloadable file
            const blob = new Blob([report], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${practiceName.replace(/\s+/g, '_')}_Digital_Tools_Report_${new Date().toISOString().split('T')[0]}.txt`;
            a.click();
            window.URL.revokeObjectURL(url);
            
            showSuccess('Report generated and downloaded!');
        }

        // Initialize app
        console.log('Firebase initialized and ready');
        
    </script>
</body>
</html>